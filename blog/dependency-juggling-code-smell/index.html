<!DOCTYPE html>
<html lang="en">
    <head>
    <title>Dependency Juggling Code Smell | Tomas Votruba</title>
    <meta charset="utf-8">
    <meta name="robots" content="index, follow">

        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">

    
    <link rel="alternate" type="application/rss+xml" title="Tomas Votruba Blog RSS" href="/rss.xml">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,700" rel="stylesheet">

        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/solid.css" integrity="sha384-wnAC7ln+XN0UKdcPvJvtqIH3jOjs9pnKnq9qX68ImXvOGz2JuFoEiCjT8jyZQX2z" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/brands.css" integrity="sha384-nT8r1Kzllf71iZl81CdFzObMsaLOhqBU1JD2+XoAALbdtWaXDOlWOZTR4v1ktjPE" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/fontawesome.css" integrity="sha384-HbmWTHay9psM8qyzEKPc8odH4DsOuzdejtnr+OFtDmOcIVnhgReQ4GZBH7uwcjf6" crossorigin="anonymous">

        <link href="/assets/bootstrap/bootstrap.min.css" rel="stylesheet" type="text/css" />

    <link href="/assets/prism/prism.css" rel="stylesheet" type="text/css" />

        <link href="/assets/css/style.css" rel="stylesheet" type="text/css" />


        <link href="/assets/css/checklist.css" rel="stylesheet" type="text/css" />
</head>
    <body>
                <!-- post_id: 313 -->

        
<div class="hidden-sm-down">
    <nav class="navbar">
        <div class="container-fluid">
            <ul>
                <li id="logo">
                    <img src="https://avatars1.githubusercontent.com/u/924196?s=60&v=4" class="me_avatar">
                    Tomas Votruba
                </li>
                <li class="active">
                    <a href="/">Blog</a>
                </li>

                <li class="">
                    <a href="/clusters">Clusters</a>
                </li>

                <li>
                    <a href="https://github.com/sponsors/TomasVotruba">Sponsor Me</a>
                </li>

                <li class="">
                    <a href="/mission">Mission</a>
                </li>
                <li class="">
                    <a href="/contact">Contact</a>
                </li>
                <li id="top-menu-search">
                    <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="https://schema.org/SearchAction">
    <meta itemprop="target" content="https://www.google.com/search?q={q}"/>
    <input name="sitesearch" value="tomasvotruba.com" type="hidden"/>
    <input itemprop="query-input" type="text" id="search-query" class="form-control" required="required" name="q" placeholder="Search..." autocomplete="off"/>
</form>
                </li>
            </ul>
        </div>
    </nav>
</div>

<div class="hidden-md-up">
    <nav class="navbar" id="mobile-menu">
        <div class="container">
            <a href="/" class="col-3 col-sm-3 active">
                <em class="fas fa-book"></em>
                <br>
                Blog
            </a>


            <a href="/clusters" class="col-3 col-sm-3 ">
                <em class="fas fa-share-alt"></em>
                <br>
                Clusters
            </a>

            <a href="/contact" class="col-3 col-sm-3 ">
                <em class="fas fa-phone"></em>
                <br>
                Contact
            </a>
        </div>
    </nav>

    <div class="hidden-md-up text-center" id="top-menu-search-mobile">
        <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="https://schema.org/SearchAction">
    <meta itemprop="target" content="https://www.google.com/search?q={q}"/>
    <input name="sitesearch" value="tomasvotruba.com" type="hidden"/>
    <input itemprop="query-input" type="text" id="search-query" class="form-control" required="required" name="q" placeholder="Search..." autocomplete="off"/>
</form>
    </div>
</div>

        <div class="container-fluid" id="post">
            <h1>Dependency Juggling Code Smell</h1>

            <ul class="list-inline post-metadata">
    <li class="list-inline-item mr-3">
        <em class="fas fa-calendar fa-fw"></em>
        <time datetime="2021-04-Mon">
            
                                            Apr 26
            
            </strike>        </time>
    </li>

    
            <li class="list-inline-item mr-3">
            <em class="fas fa-fw fa-comments"></em>
            <a href="/blog/dependency-juggling-code-smell/#disqus_thread">X</a> comments
        </li>
    
    
            <li class="list-inline-item mr-3 text-primary">
            <em class="fab fa-fw fa-github"></em>
            <a href="https://github.com/tomasvotruba/tomasvotruba.com/edit/main/packages/blog/data/2021/2021-04-26-dependency-juggling-code-smell.md">Found a typo? Edit me</a>
        </li>
    </ul>

            
            
            <div class="card card-bigger mb-5">
                <div class="card-body pb-2">
                    <p>The best way to pass dependencies is via constructor injection. Only in services, we need the dependency in. I've noticed that <strong>sometimes the dependency is passed way too early</strong>, just to be passed to another service as a method argument.
<br><br>
Why is it a code smell, and how can we avoid it?</p>
                </div>
            </div>

            <p>Because constructor injection has good karma, we automatically assume that everything in <code>__construct(...)</code> is correct. That's why we can easily miss it.</p>
<p>Imagine this code in your project:</p>
<pre><code class="language-php">final class TypeResolver
{
    public function __construct(
        // using PHP 8 property promotion here
        private StringTypeResolver $stringTypeResolver,
        private ConstantStringTypeResolver $constantStringTypeResolver,
    ) {
    }

    public function resolve(Expr $expr): Type
    {
        return $this-&gt;stringTypeResolver-&gt;resolveFromExpr(
            $expr,
            $this-&gt;constantStringTypeResolver,
        );
    }
}</code></pre>
<p>Can you see the smell in here? We have 2 services passed as a dependency in the constructor:</p>
<ul>
<li><code>StringTypeResolver</code></li>
<li><code>ConstantStringTypeResolver</code></li>
</ul>
<p>Constructor states what dependencies this class needs to work.</p>
<p><br></p>
<p>How many of them the <strong>class directly uses</strong>? Just the <code>StringTypeResolver</code> one.</p>
<p>The other one <code>ConstantStringTypeResolver</code> is juggled to <code>StringTypeResolver</code> as side dependency.</p>
<h2 id="2-pair-of-keys">2 Pair of Keys</h2>
<img src="https://user-images.githubusercontent.com/924196/116310231-03810c80-a7aa-11eb-8053-508de8ba8149.jpg" class="img-thumbnail">
<p>It's like your own keys from your home with one extra pair. You take them both with you everywhere. You use the first pair to unlock doors from your home. The extra pair you use exclusively when you open your door for your wife.</p>
<p>Why would you have these extra keys for your own? Instead, <strong>give them to your wife and let her handle it</strong>.</p>
<blockquote class="blockquote pt-3 pb-3 text-center">
Each service should take care only of its own dependencies.
<br>
not take responsibility for others.
</blockquote>
<p>If we apply this approach to our code, we can move the <code>ConstantStringTypeResolver</code> where it belongs:</p>
<pre><code class="language-diff"> final class TypeResolver
 {
     public function __construct(
        private StringTypeResolver $stringTypeResolver,
-       private ConstantStringTypeResolver $constantStringTypeResolver,
     ) {
     }

     public function resolve(Expr $expr): Type
     {
         return $this-&gt;stringTypeResolver-&gt;resolveFromExpr(
             $expr,
-            $this-&gt;constantStringTypeResolver,
         );
     }
 }</code></pre>
<p>The <code>StringTypeResolver</code> now handles its dependencies on its own:</p>
<pre><code class="language-diff"> final class StringTypeResolver
 {
+    public function __construct()
+    {
+        private ConstantStringTypeResolver $constantStringTypeResolver,
+    }

     public function resolveFromExpr(
        Expr $expr,
-       ConstantStringTypeResolver $constantStringTypeResolver,
     ) {
-        $constantStringTypeResolver-&gt;resolve(...);
+        $this-&gt;constantStringTypeResolver-&gt;resolve(...);
         // ...
     }
 }</code></pre>
<p><em class="fas fa-2x fa-thumbs-up text-warning"></em></p>
<p><br></p>
<h2 id="phpstan-got-your-back">PHPStan Got Your Back</h2>
<p>The tricky part is to watch for these cases not to get into your code. It's easy to take 2 key sets instead of 1 when you're in a rush to catch a tram or taxi.</p>
<p><a href="https://github.com/symplify/phpstan-rules">Symplify PHPStan Rules</a> got you covered. Just install it:</p>
<pre><code class="language-bash">composer require symplify/phpstan-rules --dev</code></pre>
<p>Then add the rule to your <code>phpstan.neon</code> config:</p>
<pre><code class="language-yaml">services:
     -
        class: Symplify\PHPStanRules\Rules\NoDependencyJugglingRule
        tags: [phpstan.rules.rule]</code></pre>
<p>The rule looks for constructor dependencies that are juggled to method calls. Don't worry about it, and let your CI handle it.
That's all for today.</p>
<p><br></p>
<p>Happy coding!</p>

            <br>

            <div class="row mb-5 mt-5">
                <div class="col-12 mb-5">
                                                                <a href="/blog/how-can-we-use-github-actions-in-gitlab" class="d-block pt-4 pb-4 pl-4 pr-4 btn btn-success btn-wrappable">
                            <em class="fas fa-fw fa-forward"></em>
                            <strong>Read Next</strong>
                            <br>
                            <span class="text-bigger">
                                How can We use GitHub Actions in Gitlab?
                            </span>
                        </a>
                                    </div>
            </div>

            <br>

            <a name="comments"></a>
            <div id="disqus_thread"></div>

<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://itsworthsharing.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
        </div>

        <script id="dsq-count-scr" src="https://itsworthsharing.disqus.com/count.js" async defer></script>

        <script src="/assets/js/jquery-3.3.1.slim.min.js"></script>
<script src="/assets/js/cleaning-lady-checklist.js"></script>

<script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.19/js/dataTables.bootstrap4.min.js"></script>

<script>
    ga=function(){ ga.q.push(arguments) };
    ga.q=[];
    ga.l=+new Date;
    ga('create', 'UA-46082345-1', 'auto');
    ga('send','pageview');
</script>
<script src="https://www.google-analytics.com/analytics.js" async defer></script>

<script src="/assets/prism/prism.js"></script>

<script>
    // sortable table
    $('.sortable_table').DataTable({
        // see https://datatables.net/examples/basic_init/filter_only.html
        "searching": false,
        "paging": false,
        "info": false,
        "order": [[1, "desc"]],
        // see https://datatables.net/examples/advanced_init/sort_direction_control.html
        "aoColumns": [
            null,
            { "orderSequence": [ "desc", "asc" ] },
            { "orderSequence": [ "desc", "asc" ] },
            { "orderSequence": [ "desc", "asc" ] }
        ]
    });
</script>

<div class="text-center mt-5" id="footer">
    <p class="mt-2">
        Open-source is my life. Does my work help yours? <a href="https://github.com/sponsors/TomasVotruba">Sponsor Me</a> &nbsp;
        <em class="fas fa-heart text-danger fa-lg"></em>

        &nbsp;
        <span class="pl-2 pr-2">•</span>
        &nbsp;

        See <a href="/archive">Post Archive</a>

        &nbsp;
        <span class="pl-2 pr-2">•</span>
        &nbsp;

        <a href="/rss.xml">Get RSS</a>
    </p>
</div>
    </body>
</html>

        <meta property="og:type" content="article" />
    <meta property="og:title" content="Dependency Juggling Code Smell" />
    <meta property="og:description" content="The best way to pass dependencies is via constructor injection. Only in services, we need the dependency in. I&#039;ve noticed that **sometimes the dependency is passed way too early**, just to be passed to another service as a method argument.

Why is it a code smell, and how can we avoid it?
" />
    <meta property="og:url" content="/blog/dependency-juggling-code-smell" />

        <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@votrubaT">
    <meta name="twitter:title" content="Dependency Juggling Code Smell" />
    <meta name="twitter:description" content="The best way to pass dependencies is via constructor injection. Only in services, we need the dependency in. I&#039;ve noticed that **sometimes the dependency is passed way too early**, just to be passed to another service as a method argument.

Why is it a code smell, and how can we avoid it?
" />
