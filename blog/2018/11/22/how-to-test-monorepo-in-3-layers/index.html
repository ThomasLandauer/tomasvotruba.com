<!DOCTYPE html>
<html lang="en">
    <head>
    <title>How to Test Monorepo in 3 Layers | Tomas Votruba</title>
    <meta charset="utf-8">
    <meta name="robots" content="index, follow">

        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">

    
    <link rel="alternate" type="application/rss+xml" title="Tomas Votruba Blog RSS" href="/rss.xml">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,700" rel="stylesheet">

        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/solid.css" integrity="sha384-wnAC7ln+XN0UKdcPvJvtqIH3jOjs9pnKnq9qX68ImXvOGz2JuFoEiCjT8jyZQX2z" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/brands.css" integrity="sha384-nT8r1Kzllf71iZl81CdFzObMsaLOhqBU1JD2+XoAALbdtWaXDOlWOZTR4v1ktjPE" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/fontawesome.css" integrity="sha384-HbmWTHay9psM8qyzEKPc8odH4DsOuzdejtnr+OFtDmOcIVnhgReQ4GZBH7uwcjf6" crossorigin="anonymous">

        <link href="/assets/bootstrap/bootstrap.min.css" rel="stylesheet" type="text/css" />

    <link href="/assets/prism/prism.css" rel="stylesheet" type="text/css" />

        <link href="/assets/css/style.css" rel="stylesheet" type="text/css" />


        <link href="/assets/css/checklist.css" rel="stylesheet" type="text/css" />
</head>
    <body>
                <!-- post_id: 161 -->

        
<div class="hidden-sm-down">
    <nav class="navbar">
        <div class="container-fluid">
            <ul>
                <li id="logo">
                    <img src="https://avatars1.githubusercontent.com/u/924196?s=60&v=4" class="me_avatar">
                    Tomas Votruba
                </li>
                <li class="active">
                    <a href="/">Blog</a>
                </li>
                <li class="">
                    <a href="/php-framework-trends">Trends</a>
                </li>
                <li class="">
                    <a href="/clusters">Clusters</a>
                </li>
                <li class="">
                    <a href="/projects">Projects</a>
                </li>
                <li class="">
                    <a href="/mission">Mission</a>
                </li>
                <li class="">
                    <a href="/contact">Contact</a>
                </li>
                <li id="top-menu-search">
                    <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="https://schema.org/SearchAction">
    <meta itemprop="target" content="https://www.google.com/search?q={q}"/>
    <input name="sitesearch" value="tomasvotruba.com" type="hidden"/>
    <input itemprop="query-input" type="text" id="search-query" class="form-control" required="required" name="q" placeholder="Search..." autocomplete="off"/>
</form>
                </li>
            </ul>
        </div>
    </nav>
</div>

<div class="hidden-md-up">
    <nav class="navbar" id="mobile-menu">
        <div class="container">
            <a href="/" class="col-3 col-sm-3 active">
                <em class="fas fa-book"></em>
                <br>
                Blog
            </a>


            <a href="/clusters" class="col-3 col-sm-3 ">
                <em class="fas fa-share-alt"></em>
                <br>
                Clusters
            </a>

            <a href="/projects" class="col-3 col-sm-3 ">
                <em class="fas fa-chart-bar"></em>
                <br>
                Trends
            </a>

            <a href="/contact" class="col-3 col-sm-3 ">
                <em class="fas fa-phone"></em>
                <br>
                Contact
            </a>
        </div>
    </nav>

    <div class="hidden-md-up text-center" id="top-menu-search-mobile">
        <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="https://schema.org/SearchAction">
    <meta itemprop="target" content="https://www.google.com/search?q={q}"/>
    <input name="sitesearch" value="tomasvotruba.com" type="hidden"/>
    <input itemprop="query-input" type="text" id="search-query" class="form-control" required="required" name="q" placeholder="Search..." autocomplete="off"/>
</form>
    </div>
</div>

        <div class="container-fluid" id="post">
            <h1>How to Test Monorepo in 3 Layers</h1>

            <ul class="list-inline post-metadata">
    <li class="list-inline-item mr-3">
        <em class="fas fa-calendar fa-fw"></em>
        <time datetime="2018-11-Thu">
            <strike>
                            Nov, 2018
            
            </strike>        </time>
    </li>

            <li class="list-inline-item mr-3 text-success">
            <em class="fas fa-fw fa-sync"></em> Updated Feb, 2021
        </li>
    
            <li class="list-inline-item mr-3">
            <em class="fas fa-fw fa-comments"></em>
            <a href="/blog/2018/11/22/how-to-test-monorepo-in-3-layers/#disqus_thread">X</a> comments
        </li>
    
    
            <li class="list-inline-item mr-3 text-primary">
            <em class="fab fa-fw fa-github"></em>
            <a href="https://github.com/tomasvotruba/tomasvotruba.com/edit/master/packages/blog/data/2018/2018-11-22-how-to-test-monorepo-in-3-layers.md">Found a typo? Edit me</a>
        </li>
    </ul>

            
                            <div class="card border-success card-bigger mt-5">
                    <div class="card-header text-white bg-success">
                        <strong>This post was updated at February 2021</strong>
                    </div>
                                            <div class="card-body pb-2">
                            <p>Changed from Travis to GitHub Actions, from post-split testing to local split testing.</p>
                        </div>
                                    </div>

                <br>
            
            <div class="card card-bigger mb-5">
                <div class="card-body pb-2">
                    <p>Do you have a monorepo, with 2 packages at least, autoloaded with composer and splitting works?
Good! Now you're about to set up testing and code quality tools.
<br><br>
How to make testing so tight no bug can escape?</p>
                </div>
            </div>

            <p>There are 3 layers you test your monorepo in. Most projects have 2 of them max.:</p>
<ul>
<li><strong>Testing Monorepo</strong> (Symfony, Sylius)</li>
<li><strong>Testing Standalone Packages in Monorepo</strong> (Symfony, Sylius)</li>
<li><strong>After Split Testing</strong></li>
</ul>
<p>I'm not sure why the last one is often skipped. Surprisingly, it's very easy to setup - a matter of single a new workflow file in <code>.github/workflows</code>.</p>
<p>Now we know the 3 testing layers. It's time to look <strong>why each particular layer is important</strong>.</p>
<h2 id="1-testing-monorepo">1. Testing Monorepo</h2>
<pre><code class="language-bash">/.github/workflows/...
/packages
    /first-package
    /second-package
phpunit.xml</code></pre>
<h3 id="why-is-it-important">Why is it Important?</h3>
<p>Monorepo is more complex than the classic package. The developers who use it needs to study more nested directories, special rules and exceptions he didn't have to before. He's already exhausted by learning all this and he's barely some energy left to contribute.</p>
<p>That's why <strong>your monorepo workflow has to be as simple as possible</strong>.</p>
<p>Testing should be as easy as:</p>
<pre><code class="language-bash">vendor/bin/phpunit</code></pre>
<p>One run and I we can see test are passing or failing. Must have.</p>
<h2 id="2-testing-standalone-packages-in-monorepo">2. Testing Standalone Packages in Monorepo</h2>
<pre><code class="language-diff"> /.github/workflows/...
 /packages
     /first-package
+        phpunit.xml
     /second-package
+        phpunit.xml
 phpunit.xml</code></pre>
<p>In this layer, each package has own PHPUnit setup. It still uses root <code>vendor/autoload.php</code>, but the testing scope is more similar to standalone package testing. If's <em>faking</em> split testing for poor people.</p>
<pre><code class="language-bash">vendor/bin/phpunit packages/first-package
vendor/bin/phpunit packages/second-package</code></pre>
<h3 id="why-is-it-important">Why is it Important?</h3>
<p>PHPUnit <strong>has own autoloading so it autoloads tests</strong> without relying on your <code>composer.json</code>. It's for historical reasons and also the fact, it's not standard to autoload test files or even user PSR-4 naming in them.</p>
<p><br></p>
<p>So when we run e.g. <code>vendor/bin/phpunit packages</code>, we basically tell the PHPUnit <em>autoload <code>packages</code> directory</em>.</p>
<p>What happens, when:</p>
<ul>
<li><code>packages/first-package/tests/Fixture/SomeClass.php</code> is used in test in</li>
<li><code>packages/second-package/tests/UnrelatedTest.php</code>?</li>
</ul>
<p><em class="fas fa-3x fa-times text-danger"></em></p>
<p><strong>It will silently pass</strong>. Monorepo has many classes you work with and some test classes can be accidentally reused in another package. Your test run says it passes, even though it's broken.</p>
<p>You'll find out eventually when <code>second-package</code> is downloaded and break the code to somebody but isn't automated testing suppose to prevent that?</p>
<h2 id="3-split-testing">3. Split Testing</h2>
<h3 id="why-is-it-important">Why is it Important?</h3>
<p>This is like a double condom with birth control - the best quality testing we can get. It's <strong>almost identical with real use when programmer downloads</strong> a package by <code>packages/second-package</code>.</p>
<p>Our goal is to autoload:</p>
<ul>
<li>the second-package code in <code>packages/second-package/src</code></li>
<li>dependencies from <code>packages/second-package/composer.json</code> <strong>ONLY</strong></li>
</ul>
<p><br></p>
<p>You've figured out by now <em>the why</em> by seeing <strong>ONLY</strong>. You can't find this bug in layer 1 or 2.</p>
<p>Our first package uses Doctrine <code>packages/first-package/composer.json</code></p>
<pre><code class="language-json">{
    "name": "our-project/first-package",
    "require": {
        "php": "^7.2",
        "doctrine/orm": "^2.7"
    }
}</code></pre>
<p>At the same time, <code>second-package</code> is using the Doctrine class:</p>
<pre><code class="language-php">namespace OurProject\SecondPackage;

use Doctrine\ORM\EntityManagerInterface;

final class ProductController
{
    public function __construct(EntityManagerInterface $entityManager)
    {
    }
}</code></pre>
<p>But does <strong>not require Doctrine</strong> it in <code>composer.json</code>:</p>
<pre><code class="language-json">{
    "name": "our-project/second-package",
    "require": {
        "php": "^7.2"
    }
}</code></pre>
<p>How does the GitHub Action <strong>workflow look like exactly</strong>? Checkout <a href="/blog/2020/02/10/how-to-test-monorepo-after-split-before-actual-split/">How to Test Monorepo After Split Before Actual Split</a>.</p>
<p>That's why after split testing is so important. GitHub Action will tell us!</p>
<p><br></p>
<p>Happy coding!</p>

            <br>

            <div class="row mb-5 mt-5">
                <div class="col-12 mb-5">
                                                                <a href="/blog/2018/11/19/when-you-should-use-monorepo-and-when-local-packages" class="d-block pt-4 pb-4 pl-4 pr-4 btn btn-success btn-wrappable">
                            <em class="fas fa-fw fa-forward"></em>
                            <strong>Read Next</strong>
                            <br>
                            <span class="text-bigger">
                                When You Should Use Monorepo and When Local Packages
                            </span>
                        </a>
                                    </div>
            </div>

            <br>

            <a name="comments"></a>
            <div id="disqus_thread"></div>

<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://itsworthsharing.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
        </div>

        <script id="dsq-count-scr" src="https://itsworthsharing.disqus.com/count.js" async defer></script>

        <script src="/assets/js/jquery-3.3.1.slim.min.js"></script>
<script src="/assets/js/cleaning-lady-checklist.js"></script>

<script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.19/js/dataTables.bootstrap4.min.js"></script>

<script>
    ga=function(){ ga.q.push(arguments) };
    ga.q=[];
    ga.l=+new Date;
    ga('create', 'UA-46082345-1', 'auto');
    ga('send','pageview');
</script>
<script src="https://www.google-analytics.com/analytics.js" async defer></script>

<script src="/assets/prism/prism.js"></script>

<script>
    // sortable table
    $('.sortable_table').DataTable({
        // see https://datatables.net/examples/basic_init/filter_only.html
        "searching": false,
        "paging": false,
        "info": false,
        "order": [[1, "desc"]],
        // see https://datatables.net/examples/advanced_init/sort_direction_control.html
        "aoColumns": [
            null,
            { "orderSequence": [ "desc", "asc" ] },
            { "orderSequence": [ "desc", "asc" ] },
            { "orderSequence": [ "desc", "asc" ] }
        ]
    });
</script>

<div class="text-center mt-5" id="footer">
    <p class="mt-2">
        Open-source is my life. Does it help yours? You can <a href="https://github.com/sponsors/TomasVotruba">Sponsor Me</a> &nbsp;
        <em class="fas fa-heart text-danger fa-lg"></em>

        &nbsp;
        <span class="pl-2 pr-2">•</span>
        &nbsp;

        See <a href="/archive">Post Archive</a>

        &nbsp;
        <span class="pl-2 pr-2">•</span>
        &nbsp;

        <a href="/rss.xml">Get RSS</a>
    </p>

    <br>

    <p>
        Did you know my daily focus goes to <strong>turning working with legacy code into joy</strong>?

        <br>

        With awesome <a href="https://getrector.org/">Instant Refactoring tool called Rector</a>.
    </p>
</div>
    </body>
</html>

        <meta property="og:type" content="article" />
    <meta property="og:title" content="How to Test Monorepo in 3 Layers" />
    <meta property="og:description" content="Do you have a monorepo, with 2 packages at least, autoloaded with composer and splitting works?
Good! Now you&#039;re about to set up testing and code quality tools.

How to make testing so tight no bug can escape?
" />
    <meta property="og:url" content="/blog/2018/11/22/how-to-test-monorepo-in-3-layers" />

        <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@votrubaT">
    <meta name="twitter:title" content="How to Test Monorepo in 3 Layers" />
    <meta name="twitter:description" content="Do you have a monorepo, with 2 packages at least, autoloaded with composer and splitting works?
Good! Now you&#039;re about to set up testing and code quality tools.

How to make testing so tight no bug can escape?
" />
